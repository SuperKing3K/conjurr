<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zoltarr Settings</title>
    <style>
        body { background: #111; color: #ffe066; font-family: Arial, sans-serif; }
        .settings-container { max-width: 400px; margin: 60px auto; background: #222; padding: 32px 24px; border-radius: 12px; box-shadow: 0 0 16px #0008; }
        label { display: block; margin-top: 18px; font-weight: bold; }
        input[type=text], input[type=password] { width: 100%; padding: 8px; background: #181818; color: #ffe066; border: 1px solid #444; border-radius: 4px; }
        button { margin-top: 24px; background: #ffe066; color: #222; border: none; padding: 10px 24px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .missing { color: #ff6666; font-size: 0.95em; }
    .msg { margin-top: 10px; font-size: 1.1em; }
    .msg.success { color: #66ff99; }
    .msg.error { color: #ff6666; }
        .back-link { color: #ffe066; text-decoration: underline; display: block; margin-top: 24px; }
    </style>
</head>
<body>
    <div class="settings-container">
        <h2>Zoltarr Settings</h2>
        {% if message %}
            <div class="msg{% if message_type %} {{ message_type }}{% endif %}">
                {{ message|safe }}
            </div>
        {% endif %}
    <form method="post" id="settings-form" autocomplete="off" enctype="multipart/form-data">
            <label for="TAUTULLI_URL">Tautulli URL {% if 'TAUTULLI_URL' in missing %}<span class="missing">(required)</span>{% endif %}</label>
            <input type="text" id="TAUTULLI_URL" name="TAUTULLI_URL" value="{{ settings.TAUTULLI_URL }}" required>
            <span id="tautulli-url-status" class="msg"></span>

            <label for="TAUTULLI_API_KEY">Tautulli API Key {% if 'TAUTULLI_API_KEY' in missing %}<span class="missing">(required)</span>{% endif %}</label>
            <input type="password" id="TAUTULLI_API_KEY" name="TAUTULLI_API_KEY" value="{{ settings.TAUTULLI_API_KEY }}" required>
            <span id="tautulli-key-status" class="msg"></span>

            <label for="GOOGLE_API_KEY">Google Gemini API Key {% if 'GOOGLE_API_KEY' in missing %}<span class="missing">(required)</span>{% endif %}</label>
            <input type="password" id="GOOGLE_API_KEY" name="GOOGLE_API_KEY" value="{{ settings.GOOGLE_API_KEY }}" required>
            <span id="gemini-key-status" class="msg"></span>

            <label for="TAUTULLI_DB_PATH">Tautulli DB Path (optional)</label>
            <input type="text" id="TAUTULLI_DB_PATH" name="TAUTULLI_DB_PATH" value="{{ settings.TAUTULLI_DB_PATH }}" placeholder="e.g. %LOCALAPPDATA%/Tautulli/Tautulli.db">
            <div class="msg">If not found automatically, you can upload a copy of your Tautulli.db below.</div>
            <input type="file" id="TAUTULLI_DB_FILE" name="TAUTULLI_DB_FILE" accept=".db,.sqlite,.sqlite3">

            <label for="GEMINI_DAILY_QUOTAS">Gemini Daily Quotas (optional)</label>
            <input type="text" id="GEMINI_DAILY_QUOTAS" name="GEMINI_DAILY_QUOTAS" placeholder='{"gemini-2.0-flash-001": 200}' value="{{ settings.GEMINI_DAILY_QUOTAS }}">
            <div class="msg">JSON map of model -> daily call quota. Example: {"gemini-2.0-flash-001": 200}</div>

            <button type="submit" id="save-btn">Save Settings</button>
        </form>
        <a class="back-link" href="/">&larr; Back to Recommendations</a>
    <!-- No live validation: validation will occur on form submit only -->
    </div>
    {% if redirect_main %}
    <script>
        setTimeout(function() {
            window.location.href = "/";
        }, 1000);
    </script>
    {% endif %}
    <script>
        // Mask API keys by default; reveal on focus, re-mask on blur
        (function() {
            function secureField(id) {
                var el = document.getElementById(id);
                if (!el) return;
                // Ensure masked by default
                el.type = 'password';
                el.addEventListener('focus', function() {
                    el.type = 'text';
                });
                el.addEventListener('blur', function() {
                    el.type = 'password';
                });
            }
            secureField('TAUTULLI_API_KEY');
            secureField('GOOGLE_API_KEY');
        })();
    </script>
</body>
</html>
