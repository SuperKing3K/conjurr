<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        .debug-toggle {
            position: absolute;
            top: 20px;
            left: 30px;
            z-index: 20;
            display: flex;
            align-items: center;
        }
        .debug-toggle label {
            color: #ffe066;
            font-size: 1.1em;
            margin-left: 8px;
            cursor: pointer;
        }
        .debug-section { display: none; }
        .debug-section.visible { display: block; }
    </style>
    <link rel="preload" as="image" href="/static/load.gif">
    <link rel="preload" as="image" href="/static/load2.gif">
    <link rel="preload" as="image" href="/static/load3.gif">
    <link rel="preload" as="image" href="/static/libraryload.gif">
    <style>
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        #loading-overlay img {
            width: 180px;
            height: 180px;
            display: block;
            margin: 0 auto;
        }
        #loading-overlay > div {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #loading-overlay span {
            color: #ffe066;
            font-size: 1.3em;
            margin-top: 16px;
            display: block;
            text-align: center;
        }
    </style>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <title>Zoltarr</title>
    <!-- Open Graph / Twitter Cards for rich previews -->
    <meta property="og:title" content="Zoltarr Recommendations" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ request.url }}" />
    <meta property="og:image" content="{{ url_for('static', filename='ZoltarrBig.png', _external=True) }}" />
    <meta property="og:description" content="Personalized, history-based Plex recommendations with posters and categories." />
    <meta property="og:site_name" content="Zoltarr" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Zoltarr Recommendations" />
    <meta name="twitter:description" content="Personalized, history-based Plex recommendations with posters and categories." />
    <meta name="twitter:image" content="{{ url_for('static', filename='ZoltarrBig.png', _external=True) }}" />
    <style>
        body {
            background: #111;
            color: #f0eaea;
            font-family: Arial, sans-serif;
        }
    /* Tidy bullet lists inside table cells */
    td ul { margin: 0; padding-left: 1.2em; max-height: 280px; overflow: auto; }
    td li { margin: 0 0 3px 0; }
    td, th { word-break: break-word; }
    td { vertical-align: top; }
        .zoltarr-banner {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        .zoltarr-banner img {
            width: 48px;
            height: 48px;
            margin-right: 10px;
        }
        .zoltarr-banner span {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffe066;
            text-shadow: 1px 1px 8px #000, 0 0 8px #ffe066;
            letter-spacing: 1px;
        }
        .zoltarr-banner .version {
            display: block;
            font-size: 0.95em;
            font-weight: normal;
            color: #ddd08a;
            margin-top: 2px;
            text-shadow: 1px 1px 6px #000;
        }
    table { border-collapse: collapse; width: 85%; margin: 20px auto; background: #222; color: #f0eaea; }
    th, td { border: 1px solid #444; padding: 11px; text-align: left; }
        th { background: #333; color: #ffe066; }
    select, button, label { background: #222; color: #ffe066; border: 1px solid #444; }
    /* Enlarge user selector label and dropdown items */
    label[for="user_id"] { font-size: 1.2em; }
    #user_id { font-size: 1.15em; }
    #user_id option { font-size: 1.15em; }
        pre { background: #181818; color: #ffe066; }

        /* Prominent CTA button for recommendations */
        .primary-cta {
            background: #ffe066;
            color: #222;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.15em;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.35);
            transition: transform 0.05s ease, box-shadow 0.15s ease;
            min-width: 280px;
        }
        .primary-cta:hover:not(:disabled) { box-shadow: 0 4px 14px rgba(0,0,0,0.45); }
        .primary-cta:active:not(:disabled) { transform: translateY(1px); }
        .primary-cta:disabled { opacity: 0.55; cursor: not-allowed; }

        .user-row { margin-bottom: 8px; }
        .cta-row { margin-top: 10px; }

    /* Column max-widths: allow auto sizing but cap overly wide columns */
    /* Col order: 1 Type, 2 Available Recs, 3 Not In Library, 4 AI Top 10, 5 Top 3 Watched, 6 Most Watched, 7 Recent */
    table tr > th:nth-child(1),
    table tr > td:nth-child(1) { max-width: 90px; white-space: nowrap; }

    /* Available in Library */
    table tr > td:nth-child(2) { max-width: 28rem; }
    table tr > td:nth-child(2) ul { max-width: 28rem; }

    /* AI Recs Not In Library */
    table tr > td:nth-child(3) { max-width: 24rem; }
    table tr > td:nth-child(3) ul { max-width: 24rem; }

    /* AI Top 10 */
    table tr > td:nth-child(4) { max-width: 22rem; }
    table tr > td:nth-child(4) ul { max-width: 22rem; }

    /* Top 3 Watched */
    table tr > td:nth-child(5) { max-width: 16rem; }
    table tr > td:nth-child(5) ul { max-width: 16rem; }

    /* Most Watched (single item) */
    table tr > td:nth-child(6) { max-width: 14rem; }

    /* Recent (Last 10) */
    table tr > td:nth-child(7) { max-width: 24rem; }
    table tr > td:nth-child(7) ul { max-width: 24rem; }
    </style>
</head>
<body>
    {% if not user_mode %}
    <a href="/settings" style="position:absolute;top:60px;left:18px;color:#ffe066;text-decoration:underline;font-size:1.1em;z-index:10;">‚öôÔ∏è Settings</a>
    <div style="position:absolute;top:110px;left:18px;z-index:10;background:#222;padding:12px 18px;border-radius:8px;box-shadow:0 0 8px #0006;max-width:380px;line-height:1.6;">
        <div style="font-weight:bold;margin-bottom:6px;">Library Status (API only)</div>
        <div id="library-status" style="margin-left:2px;">
            <div>Movies: 
                <span id="movie-status">{{ movie_status_only }}</span>
                <span id="movie-status-icon" class="status-icon" title="Up to date">{% if movie_status_only == 'up to date' %}üëç{% endif %}</span>
            </div>
            <div>Shows: 
                <span id="show-status">{{ show_status_only }}</span>
                <span id="show-status-icon" class="status-icon" title="Up to date">{% if show_status_only == 'up to date' %}üëç{% endif %}</span>
            </div>
        </div>
        <form id="rebuild-library-form" style="margin-top:10px;">
            <button type="submit" style="background:#ffe066;color:#222;border:none;padding:6px 14px;border-radius:4px;font-weight:bold;cursor:pointer;">Rebuild Library DB</button>
            <span id="rebuild-msg" style="margin-left:10px;color:#66ff99;font-size:0.98em;"></span>
        </form>
    </div>
    {% endif %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var form = document.getElementById('rebuild-library-form');
        var msg = document.getElementById('rebuild-msg');
        var statusEl = document.getElementById('library-status');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                msg.textContent = 'Rebuilding...';
                var btn = form.querySelector('button[type="submit"]');
                if (btn) { btn.disabled = true; btn.textContent = 'Rebuilding...'; }
                fetch('/rebuild_library', {method: 'POST'})
                  .then(r => r.json())
                  .then(data => {
                      // Update message and library status immediately
                      msg.textContent = (data && data.status) ? data.status : 'Rebuild triggered.';
                      // Update the vertical statuses
                      var movieSpan = document.getElementById('movie-status');
                      var showSpan = document.getElementById('show-status');
                      var movieIcon = document.getElementById('movie-status-icon');
                      var showIcon = document.getElementById('show-status-icon');
                      if (movieSpan) movieSpan.textContent = 'not cached';
                      if (showSpan) showSpan.textContent = 'not cached';
                      if (movieIcon) movieIcon.textContent = '';
                      if (showIcon) showIcon.textContent = '';
                      // Trigger a quick reload so the backend starts fetching and the proper library overlay shows
                      setTimeout(function() { window.location.reload(); }, 400);
                  })
                  .catch(() => { msg.textContent = 'Error rebuilding library.'; if (btn) { btn.disabled = false; btn.textContent = 'Rebuild Library DB'; } });
            });
        }
    });
    </script>
    {% if not user_mode %}
    <div class="debug-toggle">
        <input type="checkbox" id="toggle-debug" style="width:18px;height:18px;">
        <label for="toggle-debug">Show Debug Info</label>
    </div>
    {% endif %}
    {% if show_loading %}
    <div id="loading-overlay" data-library-building="true" style="display: flex;">
        <div>
            <img id="loading-gif" src="/static/libraryload.gif" alt="Loading library...">
            <span>{{ loading_message if loading_message else "Loading library data..." }}</span>
        </div>
    </div>
    {% else %}
    <div id="loading-overlay" data-library-building="false" style="display: none;">
        <div>
            <img id="loading-gif" src="/static/load.gif" alt="Loading...">
            <span id="loading-text">Loading Zoltarr's wisdom...</span>
        </div>
    </div>
    {% endif %}
    <div class="zoltarr-banner">
        <img src="/static/load.gif" alt="Genie">
        <div>
            <span>Zoltarr knows all</span>
            {% if version %}<span class="version">{{ version }}</span>{% endif %}
            {% if recs and recs.debug and recs.debug.gemini_model_used %}
                <span class="version" style="font-size:0.9em;color:#cfc088;">Model: {{ recs.debug.gemini_model_used }}</span>
            {% endif %}
        </div>
    </div>
    <h2 style="text-align:center">History Based User Recommendations</h2>
    <form method="post" style="text-align:center; margin-bottom:20px;">
        {% if user_mode %}
        <div style="width:100%;margin:10px auto 20px auto;display:flex;flex-direction:column;align-items:center;">
                <label for="user_login">Enter Plex email or username:</label>
                <input name="user_login" id="user_login" type="text" placeholder="name@example.com or username" style="background:#222;color:#ffe066;border:1px solid #444;padding:8px 10px;border-radius:6px;min-width:280px;" />
            </div>
            {% if user_login_error %}
                <div style="color:#ff8888;margin-top:6px;">{{ user_login_error }}</div>
            {% endif %}
            <div class="cta-row">
                <button class="primary-cta" type="submit">Get Recommendations</button>
            </div>
        {% else %}
            <div class="user-row">
                <label for="user_id">Select User:</label>
                <select name="user_id" id="user_id">
                {% if users and users|length > 0 %}
                    {% for user in users %}
                        <option value="{{ user.user_id }}" {% if selected_user and user.user_id == selected_user.user_id %}selected{% endif %}>{{ user.friendly_name or user.username }}</option>
                    {% endfor %}
                {% else %}
                    <option disabled selected>No users found</option>
                {% endif %}
                </select>
            </div>
            <div class="cta-row">
                <button class="primary-cta" type="submit" {% if not users or users|length == 0 %}disabled{% endif %}>Get Recommendations</button>
            </div>
            <br>
            {% if not users or users|length == 0 %}
                <div style="color: #ff8888; margin-top: 8px;">No users returned from Tautulli. Check Settings or Tautulli connectivity.</div>
            {% endif %}
        {% endif %}
    </form>
    {% if recs %}
    <div style="width:100%;margin:10px auto 20px auto;display:flex;flex-direction:column;align-items:center;">
        <style>
            .poster-row { display:inline-flex; flex-wrap:wrap; gap:12px; align-items:flex-start; justify-content:center; }
            .poster-card { width: 140px; text-align:center; }
            .poster-card img { width: 100%; height: auto; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); }
            .poster-title { margin-top:6px; font-size:0.9em; color:#ddd; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
            .poster-section-title { color:#ffe066; margin: 10px 0 6px 0; font-weight:bold; text-align:center; font-size:1.35em; }
            .poster-box { display:inline-block; background:#1a1a1a; border:1px solid #333; border-radius:12px; padding:12px 14px 16px; box-shadow:0 2px 10px rgba(0,0,0,0.35); margin:14px 0; max-width:100%; }
            .poster-box .poster-section-title { margin: 4px 0 10px 0; }
            .user-mode-username { color:#ffe066; font-size:2rem; font-weight:700; text-align:center; padding:10px 0 6px; margin:6px 0 4px; text-shadow: 1px 1px 6px #000; }
            /* AI categories ticker */
            .ticker { position: relative; overflow: hidden; width: 100%; }
            .ticker__content { display: inline-flex; align-items: center; gap: 22px; white-space: nowrap; padding: 6px 0; animation: ticker-scroll 35s linear infinite; }
            .ticker__item { color: #ddd; font-size: 0.95em; background: #222; border: 1px solid #333; border-radius: 999px; padding: 6px 12px; }
            .ticker:hover .ticker__content { animation-play-state: paused; }
            @keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        </style>
        {% if not tmdb_enabled %}
            <div style="text-align:center;color:#ec1e1e;margin:10px 0 6px 0;">** Add TMDb API key in Settings for content posters **</div>
        {% endif %}
        {% if recs and recs.show_posters and recs.show_posters[0].href %}
            <div class="muted-note">Click a poster to open the title in Overseerr.</div>
        {% endif %}
        {% if user_mode and selected_user %}
            {% set user_name = (selected_user.friendly_name or selected_user.username) if selected_user else None %}
            {% if user_name %}
                <div class="user-mode-username">Recommendations for {{ user_name }}</div>
            {% endif %}
        {% endif %}
        <style>
            .poster-sections-row { display:flex; gap:14px; flex-wrap:wrap; justify-content:center; align-items:flex-start; }
            .poster-box.alt { background:#1a1a00; border-color:#6b6b1f; }
            .poster-box.alt .poster-section-title { color:#ffe066; }
            .muted-note { color:#ddd08a; font-size:0.9em; text-align:center; margin-top:4px; }
        </style>
        {% if recs.show_posters or recs.show_posters_unavailable %}
            <div class="poster-sections-row">
                {% if recs.show_posters %}
                <div class="poster-box">
                    <div class="poster-section-title">Shows on Plex</div>
                    <div class="poster-row" aria-label="Recommended shows posters">
                        {% for p in recs.show_posters[:9] %}
                        <div class="poster-card" title="{{ p.title }}">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;">{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-title">{{ p.title }}</div>
                            {% if p.href %}</a>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                {% endif %}
                {% if recs.show_posters_unavailable %}
                <div class="poster-box alt">
                    <div class="poster-section-title">Shows not on Plex... yet</div>
                    <div class="poster-row" aria-label="Unavailable shows posters">
                        {% for p in recs.show_posters_unavailable[:9] %}
                        <div class="poster-card" title="{{ p.title }}">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;">{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-title">{{ p.title }}</div>
                            {% if p.href %}</a>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% endif %}
        {% if recs.movie_posters or recs.movie_posters_unavailable %}
            <div class="poster-sections-row">
                {% if recs.movie_posters %}
                <div class="poster-box">
                    <div class="poster-section-title">Movies on Plex</div>
                    <div class="poster-row" aria-label="Recommended movies posters">
                        {% for p in recs.movie_posters[:9] %}
                        <div class="poster-card" title="{{ p.title }}">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;">{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-title">{{ p.title }}</div>
                            {% if p.href %}</a>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if recs.movie_posters_unavailable %}
                <div class="poster-box alt">
                    <div class="poster-section-title">Movies not on Plex... yet</div>
                    <div class="poster-row" aria-label="Unavailable movies posters">
                        {% for p in recs.movie_posters_unavailable[:9] %}
                        <div class="poster-card" title="{{ p.title }}">
                            {% if p.href %}<a href="{{ p.href }}" target="_blank" rel="noopener noreferrer" style="color:inherit;text-decoration:none;">{% endif %}
                            <img src="{{ p.url }}" alt="{{ p.title }} poster">
                            <div class="poster-title">{{ p.title }}</div>
                            {% if p.href %}</a>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        {% endif %}
        {% if recs.ai_categories %}
            <div class="poster-box" style="display:block; width:85%; max-width:980px;">
                {% set user_name = (selected_user.friendly_name or selected_user.username) if selected_user else None %}
                <div class="poster-section-title">{{ (user_name ~ "'s") if user_name else 'AI' }} Categories</div>
                <div class="ticker" aria-label="AI Categories ticker">
                    <div class="ticker__content">
                        {% for it in recs.ai_categories %}
                            <span class="ticker__item">{{ it }}</span>
                        {% endfor %}
                        {% for it in recs.ai_categories %}
                            <span class="ticker__item">{{ it }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endif %}
    {% if recs %}
    <br>
    <br>
    {% if user_mode %}
        <div style="text-align:center;margin-bottom:8px;">
            <a href="#" id="toggle-details" style="color:#ffe066;text-decoration:underline;font-size:0.95em;">show table details</a>
        </div>
        <div id="details-container" style="display:none;">
            <table>
    {% else %}
            <table>
    {% endif %}
        <tr>
            <th>Type</th>
            <th>Recommendations (Available, Unwatched)</th>
            <th>AI Recs Not In Library (Unwatched)</th>
            <th>AI Top 10 Recommendations</th>
            <th>Top 3 Watched</th>
            <th>Most Watched</th>
            <th>Recently Watched</th>
        </tr>
        <tr>
            <td>Shows</td>
            <td>
                {% if recs.shows %}
                <ul>
                    {% for it in recs.shows[:9] %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.ai_shows_unavailable %}
                <ul>
                    {% for it in recs.ai_shows_unavailable %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% set show_top = recs.ai_shows_titles if recs.ai_shows_titles else recs.ai_shows %}
                {% if show_top %}
                <ul>
                    {% for it in show_top %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.top_shows %}
                <ul>
                    {% for it in recs.top_shows %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>{% if recs.top_shows %}{{ recs.top_shows[0] }}{% else %}-{% endif %}</td>
            <td>
                {% if recs.debug and recs.debug.recent_shows %}
                <ul>
                    {% for it in recs.debug.recent_shows %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
        </tr>
        <tr>
            <td>Movies</td>
            <td>
                {% if recs.movies %}
                <ul>
                    {% for it in recs.movies[:9] %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.ai_movies_unavailable %}
                <ul>
                    {% for it in recs.ai_movies_unavailable %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% set movie_top = recs.ai_movies_titles if recs.ai_movies_titles else recs.ai_movies %}
                {% if movie_top %}
                <ul>
                    {% for it in movie_top %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if recs.top_movies %}
                <ul>
                    {% for it in recs.top_movies %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
            <td>{% if recs.top_movies %}{{ recs.top_movies[0] }}{% else %}-{% endif %}</td>
            <td>
                {% if recs.debug and recs.debug.recent_movies %}
                <ul>
                    {% for it in recs.debug.recent_movies %}<li>{{ it }}</li>{% endfor %}
                </ul>
                {% else %}-{% endif %}
            </td>
        </tr>
    </table>
    {% if user_mode %}
        </div>
    {% endif %}
    {% endif %}
    {% if recs and not user_mode %}
    <div id="timing-section" style="width:60%;margin:20px auto;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;">
            <div style="margin:10px 0;min-width:220px;">
                <b>Gemini:</b>
                <div>
                    <div>SDK: {{ recs.debug.genai_sdk if recs and recs.debug else 'N/A' }}</div>
                    <div>Model: {{ recs.debug.gemini_model_used if recs and recs.debug and recs.debug.gemini_model_used else 'N/A' }}</div>
                    {% if recs and recs.debug and recs.debug.gemini_usage %}
                        {% set u = recs.debug.gemini_usage %}
                        <div style="font-size:0.95em;color:#bbb;">
                            prompt tokens: {{ u.prompt_token_count if u.prompt_token_count is not none else 'N/A' }},
                            candidates tokens: {{ u.candidates_token_count if u.candidates_token_count is not none else 'N/A' }},
                            total: {{ u.total_token_count if u.total_token_count is not none else 'N/A' }}
                        </div>
                    {% else %}
                        <div style="font-size:0.95em;color:#bbb;">usage: N/A</div>
                    {% endif %}
                    {% if recs and recs.debug and recs.debug.gemini_usage_today %}
                        {% set d = recs.debug.gemini_usage_today %}
                        <div style="font-size:0.95em;color:#bbb;">today: {{ d.calls }} calls, {{ d.total_tokens }} tokens</div>
                    {% endif %}
                    {% if recs and recs.debug and recs.debug.gemini_daily_quota %}
                        <div style="font-size:0.95em;color:#bbb;">quota: {{ recs.debug.gemini_daily_quota }} calls; remaining: {{ recs.debug.gemini_daily_remaining }}</div>
                    {% endif %}
                </div>
            </div>
            <div style="margin:10px 0;">
                <b>Timing (seconds):</b>
                <ul>
                    <li>User history fetch: {{ recs.debug.timing.user_history|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.user_history is not none else 'N/A' }}</li>
                    <li>Top watched calc: {{ recs.debug.timing.top_watched|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.top_watched is not none else 'N/A' }}</li>
                    <li>Library fetch: {{ recs.debug.timing.library_fetch|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.library_fetch is not none else 'N/A' }}</li>
                    <li>Unwatched filter: {{ recs.debug.timing.unwatched_filter|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.unwatched_filter is not none else 'N/A' }}</li>
                    <li>Gemini call: {{ recs.debug.timing.gemini|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.gemini is not none else 'N/A' }}</li>
                    <li>AI parse: {{ recs.debug.timing.ai_parse|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.ai_parse is not none else 'N/A' }}</li>
                    <li>Fuzzy match: {{ recs.debug.timing.fuzzy_match|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.fuzzy_match is not none else 'N/A' }}</li>
                    <li>Posters fetch: {{ recs.debug.timing.posters|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.posters is not none else 'N/A' }}</li>
                </ul>
            </div>
            <div style="margin:10px 0;text-align:right;min-width:220px;">
                <b style="color:#ffe066;">Data Source:</b>
                <div>
                    {% if use_tautulli_db %}
                        Using Tautulli DB
                        {% if tautulli_db_path %}
                        <div style="font-size:0.9em;color:#bbb;max-width:260px;word-break:break-all;">{{ tautulli_db_path }}</div>
                        {% endif %}
                    {% else %}
                        Using Tautulli API
                    {% endif %}
                </div>
                {% if recs and recs.debug and recs.debug.poster_sources %}
                <div style="margin-top:8px; font-size:0.95em; color:#bbb;">
                    Posters: {{ recs.debug.poster_sources.summary }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if not user_mode %}
    <div class="debug-section" id="debug-section" style="width:50%;margin:20px auto;">
        {% if recs %}
            {% if recs.debug.library_shows_full %}
                <div><b>Library Shows (Full List):</b>
                    <pre style="white-space:pre-wrap;max-height:400px;overflow:auto;">{{ recs.debug.library_shows_full | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.library_movies_full %}
                <div><b>Library Movies (Full List):</b>
                    <pre style="white-space:pre-wrap;max-height:400px;overflow:auto;">{{ recs.debug.library_movies_full | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.fuzzy_show_matches %}
                <div><b>Fuzzy Show Matches:</b>
                    <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.fuzzy_show_matches | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.fuzzy_movie_matches %}
                <div><b>Fuzzy Movie Matches:</b>
                    <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.fuzzy_movie_matches | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
        {% endif %}
        <h3>Debug Info</h3>
        {% if debug_info.error %}
            <div style="color:red;">{{ debug_info.error }}</div>
        {% endif %}
        {% if debug_info.note %}
            <div style="color:orange;">{{ debug_info.note }}</div>
        {% endif %}
        {% if recs %}
            <div>History count: {{ recs.history_count }}</div>
            <div>Unwatched shows available: {{ recs.debug.unwatched_shows_count }}</div>
            <div>Unwatched movies available: {{ recs.debug.unwatched_movies_count }}</div>
            <div>All shows in library: {{ recs.debug.all_shows_count }}</div>
            <div>All movies in library: {{ recs.debug.all_movies_count }}</div>
            <div>Watched set count: {{ recs.debug.watched_set_count }}</div>
            <div>Gemini AI Top 10 Shows: {{ recs.debug.gemini_ai_shows|join(', ') }}</div>
            <div>Gemini AI Top 10 Movies: {{ recs.debug.gemini_ai_movies|join(', ') }}</div>
            <div>Gemini AI Shows Available in Library: {{ recs.debug.gemini_ai_shows_available|join(', ') }}</div>
            <div>Gemini AI Movies Available in Library: {{ recs.debug.gemini_ai_movies_available|join(', ') }}</div>
            <div>Show section IDs: {{ recs.debug.show_section_ids }}</div>
            <div>Movie section IDs: {{ recs.debug.movie_section_ids }}</div>
            <div>Show items found: {{ recs.debug.show_items_found }}</div>
            <div>Movie items found: {{ recs.debug.movie_items_found }}</div>
            <div>Raw libraries: <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.raw_libraries }}</pre></div>
            {% if recs.debug.get_libraries_error %}
                <div style="color:red;">get_libraries error: {{ recs.debug.get_libraries_error }}</div>
            {% endif %}
            {% if recs.debug.get_library_media_info_errors %}
                <div style="color:red;">get_library_media_info errors: {{ recs.debug.get_library_media_info_errors }}</div>
            {% endif %}
            <div style="margin-top:10px;">
                <b>Gemini (Google AI Studio) Debug:</b>
                <div><b>Prompt:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_prompt }}</pre></div>
                <div><b>Raw Response:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_raw_response }}</pre></div>
                <div><b>Parsed JSON:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_parsed_json }}</pre></div>
                <div><b>Recent shows (last 10):</b> {{ recs.debug.recent_shows|join(', ') }}</div>
                <div><b>Recent movies (last 10):</b> {{ recs.debug.recent_movies|join(', ') }}</div>
                {% if recs.debug.gemini_error %}
                    <div style="color:red;">Gemini error: {{ recs.debug.gemini_error }}</div>
                {% endif %}
            </div>
        {% endif %}
    </div>
    {% endif %}
</body>
<script>
    // Whether the library is currently being built (from server-side state via data attribute)
    var overlayEl = document.getElementById('loading-overlay');
    var libraryBuilding = !!(overlayEl && overlayEl.getAttribute('data-library-building') === 'true');
    // Debug toggle logic (only present when not in user mode)
    document.addEventListener('DOMContentLoaded', function() {
        var debugToggle = document.getElementById('toggle-debug');
        var debugSection = document.getElementById('debug-section');
        if (debugToggle && debugSection) {
            debugToggle.addEventListener('change', function() {
                if (debugToggle.checked) {
                    debugSection.classList.add('visible');
                } else {
                    debugSection.classList.remove('visible');
                }
            });
            debugSection.classList.remove('visible');
        }
    });
    // Randomly select a loading gif
    function pickLoadingGif(forceLibrary) {
        var img = document.getElementById('loading-gif');
        if (!img) return;
        if (forceLibrary || libraryBuilding) {
            img.src = '/static/libraryload.gif';
            return;
        }
        var gifs = ['/static/load.gif', '/static/load2.gif', '/static/load3.gif'];
        var idx = Math.floor(Math.random() * gifs.length);
        img.src = gifs[idx];
    }

    function pickLoadingPhrase() {
        if (libraryBuilding) return; // keep library message during build
        var phrases = [
            "Consulting Zoltarr's crystal ball...",
            "Checking out blockbuster shelves...",
            "Summoning Zoltarr's ancient wisdom...",
            "Peeking behind the velvet curtain...",
            "Looking for hidden gems...",
            "Polishing the magic lamp lol...",
            "Reading fortunes in your watch history...",
            "Asking the oracle (please hold)...",
            "Shuffling fate's deck...",
            "Zoltarr and chill?",
            "Whoops, not that movie...",
            "Uhhh... I mean, how about this one?",
            "Don't yell at the developer",
            "Fine tuning suggestions...",
            "Checking spark plugs...",
            "Reticulating Splines...",
            "Optimizing the flux capacitor...",
            "Spooling up turbines..."
        ];
        var el = document.getElementById('loading-text');
        if (!el) return;
        var idx = Math.floor(Math.random() * phrases.length);
        el.textContent = phrases[idx];
    }

    // Hide loading overlay when page is fully loaded (for initial load)
    window.addEventListener('load', function() {
        setTimeout(function() {
            var overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        }, 200); // slight delay for smoothness
    });

    // Show loading overlay on form submit and pick an appropriate gif
    document.addEventListener('DOMContentLoaded', function() {
        // Only randomize on initial load if we're NOT in library-building mode
        if (!libraryBuilding) {
            pickLoadingGif(false);
            pickLoadingPhrase();
        }
        var form = document.querySelector('form[method="post"]');
        if (form) {
            form.addEventListener('submit', function() {
                // During library build, force the library-specific gif; otherwise randomize
                pickLoadingGif(libraryBuilding);
                pickLoadingPhrase();
                var overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.style.display = 'flex';
            });
        }
        // Table details toggle for user mode
        var toggle = document.getElementById('toggle-details');
        var details = document.getElementById('details-container');
        if (toggle && details) {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                var isHidden = details.style.display === 'none' || details.style.display === '';
                details.style.display = isHidden ? 'block' : 'none';
                toggle.textContent = isHidden ? 'hide table details' : 'show table details';
            });
        }
    });
</script>
</html>
