<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        .debug-toggle {
            position: absolute;
            top: 20px;
            left: 30px;
            z-index: 20;
            display: flex;
            align-items: center;
        }
        .debug-toggle label {
            color: #ffe066;
            font-size: 1.1em;
            margin-left: 8px;
            cursor: pointer;
        }
        .debug-section { display: none; }
        .debug-section.visible { display: block; }
    </style>
    <link rel="preload" as="image" href="/static/load.gif">
    <link rel="preload" as="image" href="/static/load2.gif">
    <link rel="preload" as="image" href="/static/load3.gif">
    <link rel="preload" as="image" href="/static/libraryload.gif">
    <style>
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
        }
        #loading-overlay img {
            width: 180px;
            height: 180px;
            display: block;
            margin: 0 auto;
        }
        #loading-overlay > div {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #loading-overlay span {
            color: #ffe066;
            font-size: 1.3em;
            margin-top: 16px;
            display: block;
            text-align: center;
        }
    </style>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <title>Recommendations Table</title>
    <style>
        body {
            background: #111;
            color: #f0eaea;
            font-family: Arial, sans-serif;
        }
        .zoltarr-banner {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        .zoltarr-banner img {
            width: 48px;
            height: 48px;
            margin-right: 10px;
        }
        .zoltarr-banner span {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffe066;
            text-shadow: 1px 1px 8px #000, 0 0 8px #ffe066;
            letter-spacing: 1px;
        }
        table { border-collapse: collapse; width: 50%; margin: 20px auto; background: #222; color: #f0eaea; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { background: #333; color: #ffe066; }
        select, button, label { background: #222; color: #ffe066; border: 1px solid #444; }
        pre { background: #181818; color: #ffe066; }
    </style>
</head>
<body>
    <a href="/settings" style="position:absolute;top:60px;left:18px;color:#ffe066;text-decoration:underline;font-size:1.1em;z-index:10;">⚙️ Settings</a>
    <div style="position:absolute;top:110px;left:18px;z-index:10;background:#222;padding:12px 18px;border-radius:8px;box-shadow:0 0 8px #0006;max-width:380px;line-height:1.6;">
        <div style="font-weight:bold;margin-bottom:6px;">Library Status</div>
        <div id="library-status" style="margin-left:2px;">
            <div>Movies: <span id="movie-status">{{ movie_status_only }}</span></div>
            <div>Shows: <span id="show-status">{{ show_status_only }}</span></div>
        </div>
        <form id="rebuild-library-form" style="margin-top:10px;">
            <button type="submit" style="background:#ffe066;color:#222;border:none;padding:6px 14px;border-radius:4px;font-weight:bold;cursor:pointer;">Rebuild Library DB</button>
            <span id="rebuild-msg" style="margin-left:10px;color:#66ff99;font-size:0.98em;"></span>
        </form>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var form = document.getElementById('rebuild-library-form');
        var msg = document.getElementById('rebuild-msg');
        var statusEl = document.getElementById('library-status');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                msg.textContent = 'Rebuilding...';
                var btn = form.querySelector('button[type="submit"]');
                if (btn) { btn.disabled = true; btn.textContent = 'Rebuilding...'; }
                fetch('/rebuild_library', {method: 'POST'})
                  .then(r => r.json())
                  .then(data => {
                      // Update message and library status immediately
                      msg.textContent = (data && data.status) ? data.status : 'Rebuild triggered.';
                      // Update the vertical statuses
                      var movieSpan = document.getElementById('movie-status');
                      var showSpan = document.getElementById('show-status');
                      if (movieSpan) movieSpan.textContent = 'not cached';
                      if (showSpan) showSpan.textContent = 'not cached';
                      // Trigger a quick reload so the backend starts fetching and the proper library overlay shows
                      setTimeout(function() { window.location.reload(); }, 400);
                  })
                  .catch(() => { msg.textContent = 'Error rebuilding library.'; if (btn) { btn.disabled = false; btn.textContent = 'Rebuild Library DB'; } });
            });
        }
    });
    </script>
    <div class="debug-toggle">
        <input type="checkbox" id="toggle-debug" style="width:18px;height:18px;">
        <label for="toggle-debug">Show Debug Info</label>
    </div>
    {% if show_loading %}
    <div id="loading-overlay" data-library-building="true" style="display: flex;">
        <div>
            <img id="loading-gif" src="/static/libraryload.gif" alt="Loading library...">
            <span>{{ loading_message if loading_message else "Loading library data..." }}</span>
        </div>
    </div>
    {% else %}
    <div id="loading-overlay" data-library-building="false" style="display: none;">
        <div>
            <img id="loading-gif" src="/static/load.gif" alt="Loading...">
            <span>Loading Zoltarr's wisdom...</span>
        </div>
    </div>
    {% endif %}
    <div class="zoltarr-banner">
        <img src="/static/genie.png" alt="Genie">
        <span>Zoltarr knows all</span>
    </div>
    <h2 style="text-align:center">History Based User Recommendations</h2>
    <form method="post" style="text-align:center; margin-bottom:20px;">
        <label for="user_id">Select User:</label>
        <select name="user_id" id="user_id">
            {% for user in users %}
                <option value="{{ user.user_id }}" {% if selected_user and user.user_id == selected_user.user_id %}selected{% endif %}>{{ user.friendly_name or user.username }}</option>
            {% endfor %}
        </select>
        <button type="submit">Get Recommendations</button>
    </form>
    {% if recs %}
    <table>
        <tr>
            <th>Type</th>
            <th>Recommendations (Available in Library)</th>
            <th>AI Top 10 Recommendations</th>
            <th>Top 3 Watched</th>
            <th>Most Watched</th>
        </tr>
        <tr>
            <td>Shows</td>
            <td>{{ recs.shows|join(', ') }}</td>
            <td>{{ recs.ai_shows|join(', ') }}</td>
            <td>{{ recs.top_shows|join(', ') }}</td>
            <td>{% if recs.top_shows %}{{ recs.top_shows[0] }}{% else %}-{% endif %}</td>
        </tr>
        <tr>
            <td>Movies</td>
            <td>{{ recs.movies|join(', ') }}</td>
            <td>{{ recs.ai_movies|join(', ') }}</td>
            <td>{{ recs.top_movies|join(', ') }}</td>
            <td>{% if recs.top_movies %}{{ recs.top_movies[0] }}{% else %}-{% endif %}</td>
        </tr>
    </table>
    {% endif %}
    <div class="debug-section" id="debug-section" style="width:50%;margin:20px auto;">
        <div style="margin:10px 0;">
            <b>Timing (seconds):</b>
            <ul>
                <li>User history fetch: {{ recs.debug.timing.user_history|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.user_history is not none else 'N/A' }}</li>
                <li>Top watched calc: {{ recs.debug.timing.top_watched|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.top_watched is not none else 'N/A' }}</li>
                <li>Library fetch: {{ recs.debug.timing.library_fetch|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.library_fetch is not none else 'N/A' }}</li>
                <li>Unwatched filter: {{ recs.debug.timing.unwatched_filter|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.unwatched_filter is not none else 'N/A' }}</li>
                <li>Gemini call: {{ recs.debug.timing.gemini|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.gemini is not none else 'N/A' }}</li>
                <li>AI parse: {{ recs.debug.timing.ai_parse|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.ai_parse is not none else 'N/A' }}</li>
                <li>Fuzzy match: {{ recs.debug.timing.fuzzy_match|default('N/A')|round(2) if recs and recs.debug and recs.debug.timing and recs.debug.timing.fuzzy_match is not none else 'N/A' }}</li>
            </ul>
        </div>
        {% if recs %}
            {% if recs.debug.library_shows_full %}
                <div><b>Library Shows (Full List):</b>
                    <pre style="white-space:pre-wrap;max-height:400px;overflow:auto;">{{ recs.debug.library_shows_full | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.library_movies_full %}
                <div><b>Library Movies (Full List):</b>
                    <pre style="white-space:pre-wrap;max-height:400px;overflow:auto;">{{ recs.debug.library_movies_full | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.fuzzy_show_matches %}
                <div><b>Fuzzy Show Matches:</b>
                    <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.fuzzy_show_matches | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
            {% if recs.debug.fuzzy_movie_matches %}
                <div><b>Fuzzy Movie Matches:</b>
                    <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.fuzzy_movie_matches | tojson(indent=2) }}</pre>
                </div>
            {% endif %}
        {% endif %}
        <h3>Debug Info</h3>
        {% if debug_info.error %}
            <div style="color:red;">{{ debug_info.error }}</div>
        {% endif %}
        {% if debug_info.note %}
            <div style="color:orange;">{{ debug_info.note }}</div>
        {% endif %}
        {% if recs %}
            <div>History count: {{ recs.history_count }}</div>
            <div>Unwatched shows available: {{ recs.debug.unwatched_shows_count }}</div>
            <div>Unwatched movies available: {{ recs.debug.unwatched_movies_count }}</div>
            <div>All shows in library: {{ recs.debug.all_shows_count }}</div>
            <div>All movies in library: {{ recs.debug.all_movies_count }}</div>
            <div>Watched set count: {{ recs.debug.watched_set_count }}</div>
            <div>Gemini AI Top 10 Shows: {{ recs.debug.gemini_ai_shows|join(', ') }}</div>
            <div>Gemini AI Top 10 Movies: {{ recs.debug.gemini_ai_movies|join(', ') }}</div>
            <div>Gemini AI Shows Available in Library: {{ recs.debug.gemini_ai_shows_available|join(', ') }}</div>
            <div>Gemini AI Movies Available in Library: {{ recs.debug.gemini_ai_movies_available|join(', ') }}</div>
            <div>Show section IDs: {{ recs.debug.show_section_ids }}</div>
            <div>Movie section IDs: {{ recs.debug.movie_section_ids }}</div>
            <div>Show items found: {{ recs.debug.show_items_found }}</div>
            <div>Movie items found: {{ recs.debug.movie_items_found }}</div>
            <div>Raw libraries: <pre style="white-space:pre-wrap;max-height:200px;overflow:auto;">{{ recs.debug.raw_libraries }}</pre></div>
            {% if recs.debug.get_libraries_error %}
                <div style="color:red;">get_libraries error: {{ recs.debug.get_libraries_error }}</div>
            {% endif %}
            {% if recs.debug.get_library_media_info_errors %}
                <div style="color:red;">get_library_media_info errors: {{ recs.debug.get_library_media_info_errors }}</div>
            {% endif %}
            <div style="margin-top:10px;">
                <b>Gemini (Google AI Studio) Debug:</b>
                <div><b>Prompt:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_prompt }}</pre></div>
                <div><b>Raw Response:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_raw_response }}</pre></div>
                <div><b>Parsed JSON:</b> <pre style="white-space:pre-wrap;max-height:100px;overflow:auto;">{{ recs.debug.gemini_parsed_json }}</pre></div>
                {% if recs.debug.gemini_error %}
                    <div style="color:red;">Gemini error: {{ recs.debug.gemini_error }}</div>
                {% endif %}
            </div>
        {% endif %}
    </div>
</body>
<script>
    // Whether the library is currently being built (from server-side state via data attribute)
    var overlayEl = document.getElementById('loading-overlay');
    var libraryBuilding = !!(overlayEl && overlayEl.getAttribute('data-library-building') === 'true');
    // Debug toggle logic
    document.addEventListener('DOMContentLoaded', function() {
        var debugToggle = document.getElementById('toggle-debug');
        var debugSection = document.getElementById('debug-section');
        if (debugToggle && debugSection) {
            debugToggle.addEventListener('change', function() {
                if (debugToggle.checked) {
                    debugSection.classList.add('visible');
                } else {
                    debugSection.classList.remove('visible');
                }
            });
            // Start hidden
            debugSection.classList.remove('visible');
        }
    });
    // Randomly select a loading gif
    function pickLoadingGif(forceLibrary) {
        var img = document.getElementById('loading-gif');
        if (!img) return;
        if (forceLibrary || libraryBuilding) {
            img.src = '/static/libraryload.gif';
            return;
        }
        var gifs = ['/static/load.gif', '/static/load2.gif', '/static/load3.gif'];
        var idx = Math.floor(Math.random() * gifs.length);
        img.src = gifs[idx];
    }

    // Hide loading overlay when page is fully loaded (for initial load)
    window.addEventListener('load', function() {
        setTimeout(function() {
            var overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        }, 200); // slight delay for smoothness
    });

    // Show loading overlay on form submit and pick an appropriate gif
    document.addEventListener('DOMContentLoaded', function() {
        // Only randomize on initial load if we're NOT in library-building mode
        if (!libraryBuilding) {
            pickLoadingGif(false);
        }
        var form = document.querySelector('form[method="post"]');
        if (form) {
            form.addEventListener('submit', function() {
                // During library build, force the library-specific gif; otherwise randomize
                pickLoadingGif(libraryBuilding);
                var overlay = document.getElementById('loading-overlay');
                if (overlay) overlay.style.display = 'flex';
            });
        }
    });
</script>
</html>
